<!DOCTYPE html>
<html>
  <head>
    <title>SpoonUp - Passwort zur√ºcksetzen</title>
    <link rel="canonical" href="https://roadrider42.github.io/service/reset-external.html">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      
      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        max-width: 500px;
        width: 100%;
        overflow: hidden;
      }
      
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        padding: 40px 20px;
      }
      
      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }
      
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }
      
      .content {
        padding: 40px;
      }
      
      .loading {
        text-align: center;
        color: #666;
        font-size: 1.1rem;
      }
      
      .error {
        background: #fee;
        border: 1px solid #fcc;
        border-radius: 8px;
        padding: 20px;
        color: #c33;
        text-align: center;
        margin-bottom: 20px;
      }
      
      .success {
        background: #efe;
        border: 1px solid #cfc;
        border-radius: 8px;
        padding: 20px;
        color: #363;
        text-align: center;
        margin-bottom: 20px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }
      
      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }
      
      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }
      
      .btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }
      
      .btn:hover {
        transform: translateY(-2px);
      }
      
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .info-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        color: #666;
        font-size: 0.9rem;
      }
      
      .info-box h4 {
        color: #333;
        margin-bottom: 10px;
      }
      
      .info-box ul {
        margin-left: 20px;
      }
      
      .info-box li {
        margin-bottom: 5px;
      }
      
      .app-buttons {
        text-align: center;
        margin-top: 30px;
      }
      
      .app-buttons a {
        display: inline-block;
        padding: 12px 24px;
        margin: 5px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: transform 0.2s;
      }
      
      .app-buttons a:hover {
        transform: translateY(-2px);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      
      .btn-secondary {
        background: #f8f9fa;
        color: #333;
        border: 2px solid #ddd;
      }
      
      .password-requirements {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
        font-size: 0.9rem;
        color: #666;
      }
      
      .password-requirements h5 {
        color: #333;
        margin-bottom: 8px;
      }
      
      .password-requirements ul {
        margin-left: 15px;
      }
      
      .password-requirements li {
        margin-bottom: 3px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîê SpoonUp</h1>
        <p>Passwort zur√ºcksetzen</p>
      </div>
      
      <div class="content">
        <!-- Loading State -->
        <div id="loading-state" class="loading">
          <p>üîÑ Passwort-Reset wird verarbeitet...</p>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="error" style="display: none;">
          <p><strong>‚ùå Fehler:</strong> <span id="error-message"></span></p>
        </div>
        
        <!-- Success State -->
        <div id="success-state" class="success" style="display: none;">
          <p><strong>‚úÖ Erfolgreich:</strong> <span id="success-message"></span></p>
        </div>
        
        <!-- Password Reset Form -->
        <div id="reset-form" style="display: none;">
          <form id="password-form">
            <div class="form-group">
              <label for="new-password">Neues Passwort</label>
              <input type="password" id="new-password" placeholder="Geben Sie Ihr neues Passwort ein" required>
            </div>
            
            <div class="form-group">
              <label for="confirm-password">Passwort best√§tigen</label>
              <input type="password" id="confirm-password" placeholder="Best√§tigen Sie Ihr neues Passwort" required>
            </div>
            
            <div class="password-requirements">
              <h5>üõ°Ô∏è Passwort-Anforderungen:</h5>
              <ul>
                <li>Mindestens 8 Zeichen</li>
                <li>Mindestens ein Gro√übuchstabe</li>
                <li>Mindestens ein Kleinbuchstabe</li>
                <li>Mindestens eine Zahl</li>
              </ul>
            </div>
            
            <button type="submit" class="btn" id="submit-btn">
              üîê Passwort aktualisieren
            </button>
          </form>
        </div>
        
        <!-- Success Message after password reset -->
        <div id="success-section" style="display: none;">
          <div class="success">
            <h3>üéâ Passwort erfolgreich aktualisiert!</h3>
            <p>Ihr neues Passwort wurde gespeichert.</p>
            <p>Sie k√∂nnen sich jetzt mit Ihrem neuen Passwort anmelden.</p>
          </div>
          
          <div class="info-box">
            <h4>üöÄ N√§chste Schritte:</h4>
            <ul>
              <li>√ñffnen Sie die SpoonUp App</li>
              <li>Melden Sie sich mit Ihrem neuen Passwort an</li>
              <li>Ihr Konto ist wieder vollst√§ndig zug√§nglich</li>
            </ul>
          </div>
        </div>
        
        <!-- App Download/Open Section -->
        <div id="app-section" style="display: none;">
          <div class="app-buttons">
            <a href="#" id="open-app-btn" class="btn-primary" style="display: none;">
              üì± SpoonUp App √∂ffnen
            </a>
            <a href="#" id="download-app-btn" class="btn-secondary" onclick="alert('SpoonUp App wird bald verf√ºgbar sein!')">
              üì≤ SpoonUp App (bald verf√ºgbar)
            </a>
          </div>
        </div>
        
        <!-- Default State -->
        <div id="default-state">
          <div class="info-box">
            <h4>üîê Passwort zur√ºcksetzen</h4>
            <p>Diese Seite erm√∂glicht es Ihnen, ein neues Passwort f√ºr Ihr SpoonUp-Konto zu erstellen.</p>
            <p>Verwenden Sie den Link aus Ihrer Passwort-Reset E-Mail.</p>
          </div>
          
          <div class="info-box">
            <h4>üìß E-Mail nicht erhalten?</h4>
            <ul>
              <li>√úberpr√ºfen Sie Ihren Spam-Ordner</li>
              <li>Stellen Sie sicher, dass Ihre E-Mail-Adresse korrekt ist</li>
              <li>Warten Sie einige Minuten und versuchen Sie es erneut</li>
              <li>Kontaktieren Sie uns bei weiteren Problemen</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Supabase Configuration for SpoonUp
      const SUPABASE_URL = 'https://ddbrdvwguyhnfvicheqn.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkYnJkdndndXlobmZ2aWNoZXFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyOTc0NzcsImV4cCI6MjA2ODg3MzQ3N30.Cif5HWsuFX6hqxxwJRa5mOvny56g5bbxznjlqLX1V74';
      
      // Simple Supabase client for password reset
      class SupabaseClient {
        constructor(url, key) {
          this.url = url;
          this.key = key;
          this.session = null;
        }
        
        async verifyOtp(token, type = 'recovery') {
          console.log('Verifying OTP with Supabase...', { token: token ? 'present' : 'missing', type });
          
          const response = await fetch(`${this.url}/auth/v1/verify`, {
            method: 'POST',
            headers: {
              'apikey': this.key,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              token: token,
              type: type
            })
          });
          
          console.log('Supabase response status:', response.status);
          
          if (!response.ok) {
            const error = await response.json();
            console.error('Supabase error response:', error);
            throw new Error(error.message || `HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('Supabase success response:', result);
          
          // Store session for password update
          if (result.access_token) {
            this.session = {
              access_token: result.access_token,
              refresh_token: result.refresh_token
            };
          }
          
          return result;
        }
        
        async updatePassword(newPassword) {
          if (!this.session || !this.session.access_token) {
            throw new Error('Keine aktive Session f√ºr Passwort-Update');
          }
          
          console.log('Updating password with Supabase...');
          
          const response = await fetch(`${this.url}/auth/v1/user`, {
            method: 'PUT',
            headers: {
              'apikey': this.key,
              'Authorization': `Bearer ${this.session.access_token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              password: newPassword
            })
          });
          
          console.log('Password update response status:', response.status);
          
          if (!response.ok) {
            const error = await response.json();
            console.error('Password update error:', error);
            throw new Error(error.message || `HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('Password update success:', result);
          return result;
        }
      }
      
      // Initialize client
      const supabase = new SupabaseClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // DOM Elements
      const loadingState = document.getElementById('loading-state');
      const errorState = document.getElementById('error-state');
      const successState = document.getElementById('success-state');
      const resetForm = document.getElementById('reset-form');
      const defaultState = document.getElementById('default-state');
      const successSection = document.getElementById('success-section');
      const appSection = document.getElementById('app-section');
      const passwordForm = document.getElementById('password-form');
      const submitBtn = document.getElementById('submit-btn');
      
      // Check URL parameters when page loads
      window.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking for reset token...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || urlParams.get('access_token');
        const type = urlParams.get('type');
        
        console.log('URL params:', { 
          token: token ? 'present' : 'missing', 
          type: type || 'not specified',
          fullUrl: window.location.href 
        });
        
        if (token && (type === 'recovery' || !type)) {
          console.log('Reset token found, processing...');
          processResetToken(token);
        } else {
          console.log('No reset token found');
          hideLoading();
        }
        
        setupPasswordForm();
        setupDeepLinking();
      });
      
      function hideLoading() {
        console.log('Hiding loading state');
        loadingState.style.display = 'none';
      }
      
      function showError(message) {
        console.error('Error:', message);
        hideLoading();
        document.getElementById('error-message').textContent = message;
        errorState.style.display = 'block';
        defaultState.style.display = 'none';
      }
      
      function showSuccess(message) {
        console.log('Success:', message);
        hideLoading();
        document.getElementById('success-message').textContent = message;
        successState.style.display = 'block';
        resetForm.style.display = 'block';
        defaultState.style.display = 'none';
      }
      
      async function processResetToken(token) {
        try {
          console.log('Processing reset token...');
          
          // Get URL parameters for proper token handling
          const urlParams = new URLSearchParams(window.location.search);
          const access_token = urlParams.get('access_token');
          const refresh_token = urlParams.get('refresh_token');
          const type = urlParams.get('type');
          
          if (access_token && type === 'recovery') {
            console.log('Recovery tokens found, setting up session...');
            
            // Set up session with the tokens
            supabase.session = {
              access_token: access_token,
              refresh_token: refresh_token
            };
            
            console.log('Reset token verification successful!');
            showSuccess('Reset-Link erfolgreich verifiziert!');
          } else {
            throw new Error('Ung√ºltiger oder abgelaufener Reset-Link');
          }
          
        } catch (error) {
          console.error('Error processing reset token:', error);
          showError(error.message || 'Reset-Link konnte nicht verarbeitet werden');
        }
      }
      
      function setupPasswordForm() {
        passwordForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;
          
          // Validate passwords
          if (newPassword !== confirmPassword) {
            showError('Passw√∂rter stimmen nicht √ºberein');
            return;
          }
          
          if (newPassword.length < 8) {
            showError('Passwort muss mindestens 8 Zeichen lang sein');
            return;
          }
          
          if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(newPassword)) {
            showError('Passwort muss Gro√ü-, Kleinbuchstaben und Zahlen enthalten');
            return;
          }
          
          // Update password
          submitBtn.disabled = true;
          submitBtn.textContent = 'üîÑ Wird aktualisiert...';
          
          try {
            await supabase.updatePassword(newPassword);
            
            // Show success
            resetForm.style.display = 'none';
            successState.style.display = 'none';
            successSection.style.display = 'block';
            appSection.style.display = 'block';
            
          } catch (error) {
            console.error('Password update error:', error);
            showError(error.message || 'Passwort konnte nicht aktualisiert werden');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üîê Passwort aktualisieren';
          }
        });
      }
      
      function setupDeepLinking() {
        console.log('Setting up deep linking');
        const userAgent = navigator.userAgent;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent);
        
        if (isIOS) {
          console.log('iOS device detected, showing app open button');
          const openAppBtn = document.getElementById('open-app-btn');
          
          if (openAppBtn) {
            openAppBtn.style.display = 'inline-block';
            
            openAppBtn.addEventListener('click', function(e) {
              e.preventDefault();
              console.log('Opening SpoonUp app...');
              
              // Try to open the app using custom URL scheme
              window.location.href = 'spoonup://password-reset-complete';
              
              // If app is not installed, show message after a short delay
              setTimeout(() => {
                if (!document.hidden && !document.webkitHidden) {
                  console.log('App not installed or failed to open');
                  alert('SpoonUp App wird bald verf√ºgbar sein!');
                }
              }, 500);
            });
          }
        }
      }
    </script>
  </body>
</html>
